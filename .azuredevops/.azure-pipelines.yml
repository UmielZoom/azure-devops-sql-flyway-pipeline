trigger:
- main

pool:
  name: SelfHosted
  demands:
    - docker

variables:
  DB_NAME: InterviewDB
  DB_USER: sa
  DB_HOST: host.docker.internal
  DB_PORT: 1433

stages:
- stage: DatabaseMigration
  displayName: "Run SQL Migrations with Flyway"
  jobs:
  - job: FlywayMigration
    displayName: "Flyway SQL Migration"
    steps:
    - checkout: self

    # 1) Start SQL Server container
    - powershell: |
        # Clean up if it already exists
        docker rm -f sqlserver 2>$null

        docker run -d --name sqlserver `
          -e "ACCEPT_EULA=Y" `
          -e "MSSQL_SA_PASSWORD=$(DB_PASSWORD)" `
          -p 1433:1433 `
          mcr.microsoft.com/mssql/server:2022-latest

        docker ps --filter "name=sqlserver"
      displayName: "Start SQL Server container"

    # 2) Wait for SQL Server to be ready
    - powershell: |
        Write-Host "Waiting for SQL Server to be ready..."
        Start-Sleep -Seconds 25
      displayName: "Wait for SQL Server startup"

    # 3) Run Flyway migrations
    - powershell: |
        docker run --rm `
          -v "$(Build.SourcesDirectory)\flyway\sql:/flyway/sql" `
          flyway/flyway:10 `
          -url="jdbc:sqlserver://$(DB_HOST):$(DB_PORT);databaseName=$(DB_NAME);encrypt=true;trustServerCertificate=true" `
          -user="$(DB_USER)" `
          -password="$(DB_PASSWORD)" `
          migrate
      displayName: "Run Flyway migrations"

    # 4) (Optional) Show result and clean up
    - powershell: |
        Write-Host "Containers after migration:"
        docker ps -a
        docker rm -f sqlserver 2>$null
      displayName: "Cleanup SQL Server container"
      condition: always()
